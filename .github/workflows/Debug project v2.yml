name: "Debug project v2"

on:
  workflow_dispatch:

jobs:
  debug-project-v2:
    runs-on: ubuntu-latest
    steps:
      - name: Check secret exists
        run: |
          if [ -z "${{ secrets.PROJECT_AUTOMATION_PAT }}" ]; then
            echo "ERROR: secret PROJECT_AUTOMATION_PAT is missing. Add it and re-run."
            exit 1
          fi

      - name: Query projectV2 via GraphQL
        env:
          GH_TOKEN: ${{ secrets.PROJECT_AUTOMATION_PAT }}
        run: |
          echo "Preparing GraphQL payload..."
          python - <<'PY' > payload.json
import json
QUERY = """{
  user(login: "Ajinkyamoghe123") {
    projectV2(number: 1) {
      id
      number
      title
      isArchived
      fields(first: 50) {
        nodes {
          id
          name
          dataType
          settings
        }
      }
      items(first: 100) {
        nodes {
          id
          type
          content {
            __typename
            ... on Issue {
              id
              number
              title
              url
            }
            ... on DraftIssue {
              id
              title
            }
          }
        }
      }
    }
  }
}"""
print(json.dumps({"query": QUERY}))
PY
          echo "POSTing to GraphQL..."
          curl -s -H "Authorization: bearer $GH_TOKEN" -H "Content-Type: application/json" -d @payload.json https://api.github.com/graphql | python -m json.tool
          echo "Done."
